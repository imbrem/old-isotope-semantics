%% Commands for TeXCount
%TC:macro \cite [option:text,text]
%TC:macro \citep [option:text,text]
%TC:macro \citet [option:text,text]
%TC:envir table 0 1
%TC:envir table* 0 1
%TC:envir tabular [ignore] word
%TC:envir displaymath 0 word
%TC:envir math 0 word
%TC:envir comment 0 0

\documentclass[acmsmall,screen,review]{acmart}

\usepackage{syntax}
\renewcommand{\syntleft}{\normalfont\itshape}
\renewcommand{\syntright}{\normalfont\itshape}

\usepackage{prftree}

\newcounter{todos}
\newcommand{\TODO}[1]{{
  \stepcounter{todos}
  \begin{center}\large{\textcolor{red}{\textbf{TODO \arabic{todos}:} #1}}\end{center}
}}
\newcommand{\sorry}{\textcolor{red}{\textbf{sorry}}}

% Math fonts
\newcommand{\mc}[1]{\ensuremath{\mathcal{#1}}}
\newcommand{\mb}[1]{\ensuremath{\mathbf{#1}}}
\newcommand{\ms}[1]{\ensuremath{\mathsf{#1}}}

% Syntax atoms
\newcommand{\lbl}[1]{{`#1}}
\newcommand{\lto}{\Rightarrow}
\newcommand{\ctt}{\ms{tt}}
\newcommand{\cff}{\ms{ff}}

% Syntax
\newcommand{\letexpr}[3]{\ensuremath{\ms{let}\;#1 = #2\;\ms{in}\;#3}}
\newcommand{\letstmt}[3]{\ensuremath{\ms{let}\;#1 = #2; #3}}
\newcommand{\brb}[2]{\ms{br}\;#1\;#2}
\newcommand{\lbrb}[2]{\brb{\lbl{#1}}{#2}}
\newcommand{\ite}[3]{\ms{if}\;#1\;\{#2\}\;\ms{else}\;\{#3\}}
\newcommand{\ewhere}[2]{\ms{then}\;#1\;\ms{where}\;#2}
\newcommand{\where}[2]{#1\;\ms{where}\;#2}
\newcommand{\wbranch}[3]{#1(#2) \lto #3}
\newcommand{\lwbranch}[3]{\wbranch{\lbl{#1}}{#2}{#3}}
\newcommand{\bsplice}[3]{#1(#2)\;\{#3\}}
\newcommand{\lbsplice}[3]{\bsplice{\lbl{#1}}{#2}{#3}}
\newcommand{\csplits}[3]{#1 \mapsto #2;#3}
\newcommand{\cwk}[2]{#1 \mapsto #2}
\newcommand{\lwk}[2]{#1 \rightsquigarrow #2}
\newcommand{\tlin}[2]{\ms{lin}_{#2}(#1)}
\newcommand{\ltlin}[3]{\ms{lin}_{#3}(#1^{#2})}
\newcommand{\thyp}[3]{#1: {#2}^{#3}}
\newcommand{\lhyp}[3]{#1[#2](#3)}
\newcommand{\llhyp}[3]{\lhyp{\lbl{#1}}{#2}{#3}}
\newcommand{\rle}[1]{{\scriptsize\textsf{#1}}}
\newcommand{\taff}{\ms{a}}
\newcommand{\trel}{\ms{r}}
\newcommand{\tint}{\infty}
\newcommand{\hasty}[4]{#1 \vdash_{#2} #3: #4}
\newcommand{\haslb}[3]{#1 \vdash #2 \rhd #3}
\newcommand{\lhaslb}[3]{#1 \vdash #2 \rhd #3}
\newcommand{\issubst}[3]{#1: #2 \mapsto #3}
\newcommand{\substcons}[3]{[{#2 \mapsto #3}]{#1}}

% Denotational semantics
\newcommand{\dnt}[1]{\llbracket{#1}\rrbracket}
\newcommand{\ednt}[1]{\left\llbracket{#1}\right\rrbracket}
\newcommand{\upg}[2]{{#1}^{\uparrow #2}}

% Branding
\newcommand{\isotopessa}{\ms{isotope_{SSA}}}

%% Rights management information.  This information is sent to you
%% when you complete the rights form.  These commands have SAMPLE
%% values in them; it is your responsibility as an author to replace
%% the commands and values with those provided to you when you
%% complete the rights form.
\setcopyright{acmcopyright}
\copyrightyear{2018}
\acmYear{2018}
\acmDOI{XXXXXXX.XXXXXXX}

%%
%% These commands are for a JOURNAL article.
% \acmJournal{JACM}
% \acmVolume{37}
% \acmNumber{4}
% \acmArticle{111}
% \acmMonth{8}

%%
%% Submission ID.
%% Use this when submitting an article to a sponsored event. You'll
%% receive a unique submission ID from the organizers
%% of the event, and this ID should be used as the parameter to this command.
%%\acmSubmissionID{123-A56-BU3}

%%
%% The majority of ACM publications use numbered citations and
%% references.  The command \citestyle{authoryear} switches to the
%% "author year" style.
%%
%% If you are preparing content for an event
%% sponsored by ACM SIGGRAPH, you must use the "author year" style of
%% citations and references.
%% Uncommenting
%% the next command will enable that style.
%%\citestyle{acmauthoryear}

\begin{document}

\title{Denotational Semantics for SSA with Weak Memory Operations}

\author{Neel Krishnaswami}
\email{nk480@cl.cam.ac.uk}
\orcid{0000-0003-2838-5865}

\author{Jad Ghalayini}
\email{jeg74@cl.cam.ac.uk}
\orcid{0000-0002-6905-1303}

\begin{abstract}
  TODO THIS
\end{abstract}

%%
%% The code below is generated by the tool at http://dl.acm.org/ccs.cfm.
%% Please copy and paste the code instead of the example below.
%%
\begin{CCSXML}
<ccs2012>
 <concept>
  <concept_id>00000000.0000000.0000000</concept_id>
  <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
  <concept_significance>500</concept_significance>
 </concept>
 <concept>
  <concept_id>00000000.00000000.00000000</concept_id>
  <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
  <concept_significance>300</concept_significance>
 </concept>
 <concept>
  <concept_id>00000000.00000000.00000000</concept_id>
  <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
  <concept_significance>100</concept_significance>
 </concept>
 <concept>
  <concept_id>00000000.00000000.00000000</concept_id>
  <concept_desc>Do Not Use This Code, Generate the Correct Terms for Your Paper</concept_desc>
  <concept_significance>100</concept_significance>
 </concept>
</ccs2012>
\end{CCSXML}

\ccsdesc[500]{Do Not Use This Code~Generate the Correct Terms for Your Paper}
\ccsdesc[300]{Do Not Use This Code~Generate the Correct Terms for Your Paper}
\ccsdesc{Do Not Use This Code~Generate the Correct Terms for Your Paper}
\ccsdesc[100]{Do Not Use This Code~Generate the Correct Terms for Your Paper}

%%
%% Keywords. The author(s) should pick words that accurately describe
%% the work being presented. Separate the keywords with commas.
\keywords{TODO PUT KEYWORDS HERE}

% \received{20 February 2007}
% \received[revised]{12 March 2009}
% \received[accepted]{5 June 2009}

\maketitle

\section{Introduction}

\TODO{THIS}

\paragraph{Contributions}

\begin{itemize}
\item We have a syntax and type system for SSA-style programs. We include support for substructural types, and our type-theoretic syntax makes formulating inlining and rewriting easier than in the traditional CFG-based formulations. 
\item We show that our language has a compositional intepretation in any effectful category with an Elgot structure. We use this structure to give generic proofs of the expected substitution properties as well as prove the soundness of an equational theory for the language.
\item Our generic equational theory justifies a variety of powerful optimisation techniques, including E-graph rewriting, inlining, loop fusion, hoisting, and strength reduction. 
\item We show how Elgot monads give rise to models of our language. We use this to derive semantics from a general trace monad, and show that various monad transformers such as state transformers preserve the needed Elgot structure. 
\item We use these tools to demonstrate the existence of a variety of concrete models satisfying these categorical axioms. Starting first from simple languges such as state plus printing, we also show how more challenging semantics such as the TSO semantics for weak memory also fit into our framework. This thus gives rise to an SSA-based IR with support for weak memory operations, which is fully semantically-justified.
\item \TODO{We also have a small implementation, which \ldots}
\item Our weak memory semantics and our results about Elgot monads are formalised in the Lean theorem prover. \TODO{Other stuff}
\end{itemize}

\section{SSA Syntax}

\TODO{text}

\begin{figure}
  \begin{center}
    \begin{grammar}
      <\(A, B, C\)> ::= \(X\)
      \;|\; \(A \otimes B\)

      <\(a, b, c, e\)> ::= \(x\) 
      \;|\; \(f\;a\)
      \;|\; \((a, b)\) 
      \;|\; \(()\) 
      \;|\; \(\ctt\) 
      \;|\; \(\cff\)
      \;|\; \(\letexpr{x}{a}{e}\)
      \;|\; \(\letexpr{(x, y)}{a}{e}\)
      \;|\; \(\lbsplice{\ell}{x: A}{t}\)
      
      <\(s, t\)> ::= \(\lbrb{\ell}{a}\) 
      \;|\; \(\ite{e}{s}{t}\)
      \;|\; \(\letstmt{x}{a}{t}\)
      \;|\; \(\letstmt{(x, y)}{a}{t}\)
      \;|\; \(\ewhere{t}{L}\)

      <\(L\)> ::= \(\cdot\) \;|\; \(\lwbranch{\ell}{x: A}{t}, L\)

      <\(\Gamma\)> ::= \(\cdot\) \;|\; \(\Gamma, \thyp{x}{A}{q}\)

      <\(\ms{L}\)> ::= \(\cdot\) \;|\; \(\ms{L}, \lbl{\ell}[\Gamma](x: A)\)
    \end{grammar}
  \end{center}
  \caption{Grammar for \isotopessa}
  \Description{Grammar for isotope-SSA}
  \label{fig:ssa-grammar}
\end{figure}

\TODO{late \ms{where}-binding, and other sugar (?)}

\TODO{top-level functions}

\TODO{table of typing judgements}

\TODO{contexts, label-contexts}

\begin{figure}
  \begin{center}        
    \begingroup
    \renewcommand{\arraystretch}{1.5}
    \setlength{\tabcolsep}{2em}
    \begin{tabular}{rl}
        \multicolumn{1}{c}{Judgment} & \multicolumn{1}{c}{Meaning} \\ \hline
        \(\hasty{\Gamma}{p}{x}{A}\) &
        \(a\) is a term of type \(A\) in context \(\Gamma\) with purity \(p \in \{0, 1\}\) \\
        \(\haslb{\Gamma}{t}{\ms{L}}\) &
        \(t\) is a block targeting label-set \(\ms{L}\) in context \(\Gamma\) \\
        \(\lhaslb{\ms{L}}{L}{\ms{K}}\) &
        The labels \(L\) send label-set \(\ms{L}\) to label-set \(\ms{K}\) \\
        \(\csplits{\Gamma}{\Delta}{\Xi}\) &
        The context \(\Gamma\) splits into \(\Delta\) and \(\Xi\) \\
        \(\lwk{\ms{L}}{\ms{K}}\) &
        The label-set \(\ms{L}\) weakens to the label-set \(\ms{K}\) \\
        \(\tlin{A}{q}\) &
        The type \(A\) has linearity \(q\) \\
        \(\ltlin{A}{r}{q}\) &
        The type \(A\) has linearity \(q \subseteq r\)
        (i.e. \(\tlin{A}{q} \land q \subseteq r\)) \\
        \(\tlin{\Gamma}{q}\) &
        The context \(\Gamma\) has linearity \(q\) \\
        \(\cwk{\Gamma}{\Delta}\) &
        \(\Gamma\) is a weakening of \(\Delta\) 
        (i.e. \(\csplits{\Gamma}{\Delta}{\cdot}\))
    \end{tabular}
    \endgroup
  \end{center}
  \caption{Typing judgements for \isotopessa}
  \Description{Typing judgements for isotope-SSA}
  \label{fig:ssa-judgements}
\end{figure}

\begin{figure}
  \begin{gather*}    
    \prftree[r]{\rle{base-lin}}{q \subseteq \ms{lin}(X)}{\tlin{X}{q}} \qquad
    \prftree[r]{\rle{pair-lin}}{\tlin{A}{q}}{\tlin{B}{q}}{\tlin{A \otimes B}{q}} \qquad
    \prftree[r]{\rle{nil-lin}}{\tlin{\cdot}{q}} \qquad
    \prftree[r]{\rle{cons-lin}}{\ltlin{A}{r}{q}}{\tlin{\Gamma}{q}}
      {\tlin{\Gamma, \thyp{x}{A}{r}}{q}} \\
    \prftree[r]{\rle{split-nil}}{\csplits{\cdot}{\cdot}{\cdot}} \qquad
    \prftree[r]{\rle{split-left}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {r \subseteq q}
      {\csplits{\Gamma, \thyp{x}{A}{q}}{\Delta, \thyp{x}{A}{r}}{\Xi}} \qquad
    \prftree[r]{\rle{split-right}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {r \subseteq q}
      {\csplits{\Gamma, \thyp{x}{A}{q}}{\Delta}{\Xi, \thyp{x}{A}{r}}} \\
    \prftree[r]{\rle{split-dup}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\ltlin{A}{q}{\trel}}
      {r, s \subseteq q}
      {\csplits{\Gamma, \thyp{x}{A}{q}}{\Delta, \thyp{x}{A}{r}}{\Xi, \thyp{x}{A}{s}}}
      \qquad
    \prftree[r]{\rle{split-drop}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\ltlin{A}{q}{\taff}}
      {\csplits{\Gamma, \thyp{x}{A}{q}}{\Delta}{\Xi}}
      \\
    \prftree[r]{\rle{join-nil}}{\lwk{\cdot}{\cdot}} \qquad
    \prftree[r]{\rle{join-cons}}
      {\lwk{\ms{L}}{\ms{K}}}
      {\lwk{\ms{L}, \llhyp{\ell}{\Gamma}{A}}{\ms{K}, \llhyp{\ell}{\Gamma}{A}}} 
      \qquad
    \prftree[r]{\rle{join-zero}}
      {\lwk{\ms{L}}{\ms{K}}}
      {\lwk{\ms{L}}{\ms{K}, \llhyp{\ell}{\Gamma}{A}}} 
  \end{gather*}
  \caption{Structural rules for \isotopessa}
  \Description{Structural rules for isotope-SSA}
  \label{fig:ssa-structural}
\end{figure}

\begin{figure}
  \begin{gather*}    
    \prftree[r]{\rle{var}}
      {\cwk{\Gamma}{\thyp{x}{A}{q}}}
      {\hasty{\Gamma}{p}{x}{A}} \qquad
    \prftree[r]{\rle{app}}
      {f \in \mc{I}_p(A, B)}
      {\hasty{\Gamma}{1}{a}{A}}
      {\hasty{\Gamma}{p}{f\;a}{B}} \qquad
    \prftree[r]{\rle{pair}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\hasty{\Delta}{1}{a}{A}}
      {\hasty{\Xi}{1}{b}{B}}
      {\hasty{\Gamma}{p}{(a, b)}{A \otimes B}} \\
    \prftree[r]{\rle{unit}}
      {\cwk{\Gamma}{\cdot}}
      {\hasty{\Gamma}{p}{()}{\mb{1}}} \qquad
    \prftree[r]{\rle{true}}
      {\cwk{\Gamma}{\cdot}}
      {\hasty{\Gamma}{p}{\ctt}{\mb{2}}} \qquad
    \prftree[r]{\rle{false}}
      {\cwk{\Gamma}{\cdot}}
      {\hasty{\Gamma}{p}{\cff}{\mb{2}}} \\
    \prftree[r]{\rle{let}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\hasty{\Delta, \thyp{x}{A}{}}{p}{e}{B}}
      {\hasty{\Xi}{1}{a}{A}}
      {\hasty{\Gamma}{p}{\letexpr{x}{a}{e}}{B}} \qquad
    \prftree[r]{\rle{blk}}
      {\haslb{\Gamma}{t}{\llhyp{\ell}{\cdot}{A}}}
      {\hasty{\Gamma}{0}{\lbsplice{\ell}{A}{t}}{A}} \\
    \prftree[r]{\rle{let2}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\hasty{\Delta, \thyp{x}{A}{}, \thyp{y}{B}{}}{p}{e}{C}}
      {\hasty{\Xi}{1}{a}{A \otimes B}}
      {\hasty{\Gamma}{p}{\letexpr{(x, y)}{a}{e}}{C}}
  \end{gather*}
  \caption{Typing rules for \isotopessa terms}
  \Description{Typing rules for isotope-SSA terms}
  \label{fig:ssa-term-typing}
\end{figure}

\begin{figure}
  \begin{gather*}    
    \prftree[r]{\rle{br}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\lwk{\llhyp{\ell}{\Delta}{A}}{\ms{L}}}
      %TODO: consider allowing binding here, or should it be purely for lets?
      {\hasty{\Xi}{0}{a}{A}}
      {\haslb{\Gamma}{\lbrb{\ell}{a}}{\ms{L}}} \qquad
    \prftree[r]{\rle{ite}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\hasty{\Delta}{0}{e}{\mb{2}}}
      {\haslb{\Xi}{s}{\ms{L}}}
      {\haslb{\Xi}{t}{\ms{L}}}
      {\haslb{\Gamma}{\ite{e}{s}{t}}{\ms{L}}} \\
    \prftree[r]{\rle{let-blk}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\haslb{\Delta, \thyp{x}{A}{}}{t}{\ms{L}}}
      {\hasty{\Xi}{1}{a}{A}}
      {\haslb{\Gamma}{\letstmt{x}{a}{t}}{\ms{L}}} \\
    \prftree[r]{\rle{let2-blk}}
      {\csplits{\Gamma}{\Delta}{\Xi}}
      {\haslb{\Delta, \thyp{x}{A}{}, \thyp{y}{B}{}}{t}{\ms{L}}}
      {\hasty{\Xi}{1}{a}{A \otimes B}}
      {\haslb{\Gamma}{\letstmt{(x, y)}{a}{t}}{\ms{L}}} \\
    \prftree[r]{\rle{where}}
      {\haslb{\Gamma}{t}{\ms{L}}}
      {\lhaslb{\ms{L}}{L}{\ms{K}}}
      {\haslb{\Gamma}{\ewhere{t}{L}}{\ms{K}}} \qquad
    \prftree[r]{\rle{nil-br}}
      {\lhaslb{\ms{L}}{\cdot}{\ms{L}}} \qquad
    \prftree[r]{\rle{cons-br}}
      {\lhaslb{\ms{L}}{L}{\ms{K}, \llhyp{\ell}{\Gamma}{A}}}
      {\haslb{\Gamma, \thyp{x}{A}{}}{t}{\ms{L}}}
      {\lhaslb{\ms{L}}{L, \lwbranch{\ell}{x: A}{t}}{\ms{K}}}
  \end{gather*}
  \caption{Typing rules for \isotopessa blocks}
  \Description{Typing rules for isotope-SSA blocks}
  \label{fig:ssa-block-typing}
\end{figure}

\begin{figure}
  \begin{gather*}
    \prftree[r]{\rle{subst-nil}}
      {\issubst{\cdot}{\cdot}{\cdot}}
      \qquad
    \prftree[r]{\rle{subst-cons}}
      {\issubst{\gamma}{\Theta_\Gamma}{\Gamma}}
      {\hasty{\Theta_x}{0}{a}{A}}
      {\tlin{\Theta_x}{q}}
      {\csplits{\Theta}{\Theta_\Gamma}{\Theta_x}}
      {\issubst{\substcons{\gamma}{x}{a}}{\Theta}{\Gamma, \thyp{x}{A}{q}}}
  \end{gather*}
  \caption{Typing rules for \isotopessa substitutions}
  \Description{Typing rules for isotope-SSA substitutions}
  \label{fig:ssa-subst-typing}
\end{figure}

\TODO{label substitution}

\begin{theorem}[Substitution] 
  Given \(\issubst{\gamma}{\Theta}{\Gamma}\),
  \begin{itemize}
    \item If \(\hasty{\Gamma}{p}{a}{A}\), then \(\hasty{\Theta}{p}{[\gamma]a}{A}\)
    \item If \(\haslb{\Gamma}{t}{\ms{L}}\), then \(\haslb{\Theta}{[\gamma]t}{[\gamma]\ms{L}}\)
  \end{itemize}
\end{theorem}

\section{SSA Semantics}

\TODO{premonoidal categories}

\TODO{Elgot structure}

\begin{figure}
  \begin{gather*}
    \boxed{\dnt{A}}: |\mc{C}_1| \\
    \dnt{X} = \ms{base}(X) 
      \text{ where } 
      \dnt{\mb{1}} = \mb{1}, 
      \dnt{\mb{2}} = \mb{2}
    \qquad \dnt{A \otimes B} = \dnt{A} \otimes \dnt{B} \\
    \boxed{\dnt{\Gamma}}: |\mc{C}_1| \\
    \dnt{\cdot} = \mb{1} \qquad 
    \dnt{\Gamma, \thyp{x}{A}{q}} = \dnt{\Gamma} \otimes \dnt{A} \\
    \boxed{\dnt{\ms{L}}}: |\mc{C}_0| \\
    \dnt{\cdot} = \mb{0} \qquad
    \dnt{\ms{L}, \llhyp{\ell}{\Gamma}{A}} = 
      \dnt{\ms{L}} + \dnt{\Gamma} \otimes \dnt{A}
  \end{gather*}
  \caption{Semantics for \isotopessa types and contexts}
  \Description{Semantics for isotope-SSA types and contexts}
  \label{fig:ssa-type-semantics}
\end{figure}

\begin{figure}
  \begin{gather*}
    \boxed{\dnt{\tlin{A}{\taff}}: \mc{C}_1(\dnt{A}, \mb{1})} \\
    \dnt{\tlin{X}{\taff}} = \ms{drop}(X) \qquad
    \dnt{\tlin{A \otimes B}{\taff}} 
      = \dnt{\tlin{A}{\taff}} \otimes \dnt{\tlin{B}{\taff}}
      ; \lambda \\
    \boxed{\dnt{\tlin{A}{\trel}}}
      : \mc{C}_1(\dnt{A}, \dnt{A} \otimes \dnt{A}) \\
    \dnt{\tlin{X}{\trel}} = \ms{split}(X) \qquad
    \dnt{\tlin{A \otimes B}{\trel}} = 
      \dnt{\tlin{A}{\trel}} \otimes \dnt{\tlin{B}{\trel}}
      ;\alpha;\dnt{A} \otimes \sigma \otimes \dnt{B};\alpha \\
    \boxed{\dnt{\csplits{\Gamma}{\Delta}{\Xi}}}
      : \mc{C}_1(\dnt{\Gamma}, \dnt{\Delta} \otimes \dnt{\Xi}) \\
    \dnt{\csplits{\cdot}{\cdot}{\cdot}} = \lambda^{-1} \qquad
    \dnt{\csplits
      {\Gamma, \thyp{x}{A}{q}}
      {\Delta, \thyp{x}{A}{q}}
      {\Xi}} 
      = \dnt{\csplits{\Gamma}{\Delta}{\Xi}} \otimes \dnt{A};\alpha;\dnt{\Delta} \otimes \sigma;\alpha \\
    \dnt{\csplits
      {\Gamma, \thyp{x}{A}{q}}
      {\Delta}
      {\Xi, \thyp{x}{A}{q}}} 
      = \dnt{\csplits{\Gamma}{\Delta}{\Xi}} \otimes \dnt{A};\alpha \\
    \dnt{\csplits
      {\Gamma, \thyp{x}{A}{q}}
      {\Delta}
      {\Xi, \thyp{x}{A}{q}}} \
      = \dnt{\Gamma} \otimes \dnt{\tlin{A}{\trel}};
        \alpha;
        \dnt{\Delta} \otimes \sigma \otimes \dnt{A};
        \alpha \\
    \dnt{\csplits
      {\Gamma, \thyp{x}{A}{q}}
      {\Delta}
      {\Xi}}
      = \dnt{\csplits{\Gamma}{\Delta}{\Xi}}
        \otimes \dnt{\tlin{A}{\taff}}
      ; \rho \\
    \boxed{\dnt{\cwk{\Gamma}{\Delta}}
      : \mc{C}_1(\dnt{\Gamma}, \dnt{\Delta})} \\
      = \dnt{\csplits{\Gamma}{\Delta}{\cdot}};\rho \\
    \boxed{\dnt{\lwk{\ms{L}}{\ms{K}}}
      : \mc{C}_0(\dnt{\ms{L}}, \dnt{\ms{K}})} \\
      \dnt{\lwk{\cdot}{\cdot}} = \ms{id} \qquad
      \dnt{\lwk
        {\ms{L}, \llhyp{\ell}{\Gamma}{A}}
        {\ms{K}, \llhyp{\ell}{\Gamma}{A}}}
        = \dnt{\lwk{\ms{L}}{\ms{K}}} + \dnt{\Gamma} \otimes \dnt{A} \\
      \dnt{\lwk{\ms{L}}{\ms{K}, \llhyp{\ell}{\Gamma}{A}}}
        = \dnt{\lwk{\ms{L}}{\ms{K}}};\rho_+^{-1}
        ; \dnt{\ms{K}} \oplus 0_{\dnt{\Gamma} \otimes \dnt{A}}
  \end{gather*}
  \caption{Semantics for \isotopessa structural judgements}
  \Description{Semantics for isotope-SSA structural judgements}
  \label{fig:ssa-structural-semantics}
\end{figure}

\begin{figure}
  \begin{gather*}
    \boxed{\dnt{\hasty{\Gamma}{p}{a}{A}}
      : \mc{C}_p(\dnt{\Gamma}, \dnt{A})} \\
    \dnt{\hasty{\Gamma}{p}{x}{A}} 
      = \dnt{\cwk{\Gamma}{\thyp{x}{A}{q}}}
      \qquad
    \dnt{\hasty{\Gamma}{p}{f\;a}{B}}
      = \upg{\dnt{\hasty{\Gamma}{1}{a}{A}}}{p}
      ; \ms{inst}_p(f) \\
    \dnt{\hasty{\Gamma}{p}{(a, b)}{A \otimes B}}
      = \upg{(
        \dnt{\csplits{\Gamma}{\Delta}{\Xi}};
        \dnt{\hasty{\Delta}{1}{a}{A}} \otimes
        \dnt{\hasty{\Xi}{1}{b}{B}}
      )}{\uparrow p} \\
    \dnt{\hasty{\Gamma}{p}{()}{\mb{1}}}
      = \upg{\dnt{\cwk{\Gamma}{\cdot}}}{p} 
      \qquad
    \dnt{\hasty{\Gamma}{p}{\ctt}{\mb{2}}}
      = \upg{(\dnt{\cwk{\Gamma}{\cdot}};\ctt)}{p}
      \qquad
    \dnt{\hasty{\Gamma}{p}{\cff}{\mb{2}}}
      = \upg{(\dnt{\cwk{\Gamma}{\cdot}};\cff)}{p} \\
    \dnt{\hasty{\Gamma}{p}{\letexpr{x}{a}{e}}{B}}
      = \upg{(
        \dnt{\csplits{\Gamma}{\Delta}{\Xi}}
        ; \dnt{\Delta} \otimes \dnt{\hasty{\Xi}{1}{a}{A}}
      )}{p};\dnt{\hasty{\Delta, \thyp{x}{A}{}}{p}{e}{B}} \\
    \dnt{\hasty{\Gamma}{p}{\letexpr{(x, y)}{a}{e}}{C}}
      = \upg{(
        \dnt{\csplits{\Gamma}{\Delta}{\Xi}}
        ; \dnt{\Delta} \otimes \dnt{\hasty{\Xi}{1}{a}{A \otimes B}}
      )}{p}
      ; 
      \\ \qquad \qquad \qquad \qquad \qquad \alpha
      ; \dnt{\hasty{\Delta, \thyp{x}{A}{}, \thyp{y}{B}{}}{p}{e}{C}}
      \\
    \dnt{\hasty{\Gamma}{0}{\lbsplice{\ell}{A}{t}}{A}}
      = \dnt{\haslb{\Gamma}{t}{\llhyp{\ell}{\cdot}{A}}};\alpha_+
  \end{gather*}
  \caption{Semantics for \isotopessa terms}
  \Description{Semantics for isotope-SSA terms}
  \label{fig:ssa-structural-terms}
\end{figure}

\begin{figure}
  \begin{gather*}
    \boxed{\dnt{\haslb{\Gamma}{t}{\ms{L}}}
      : \mc{C}_1(\dnt{\Gamma}, \dnt{\ms{L}})} \\
    \dnt{\haslb{\Gamma}{\lbrb{\ell}{a}}{\ms{L}}}
      = \upg{(\dnt{\csplits{\Gamma}{\Delta}{\Xi}}
      ; \dnt{\Delta} \otimes \dnt{\hasty{\Xi}{0}{a}{A}})}
      ; \dnt{\lwk{\llhyp{\ell}{\Delta}{A}}{\ms{L}}} \\
    \dnt{\haslb{\Gamma}{\ite{e}{s}{t}}{\ms{L}}}
      = \upg{(\dnt{\csplits{\Gamma}{\Delta}{\Xi}}
      ; \dnt{\hasty{\Delta}{0}{e}{\mb{2}}} \otimes \dnt{\Xi})}
      ; \ms{ite}_{\dnt{\Xi}} ;
      \\ \qquad \qquad \qquad \qquad
      [
        \dnt{\haslb{\Xi}{s}{\ms{L}}}, 
        \dnt{\haslb{\Xi}{t}{\ms{L}}} 
      ]
      \\
    \dnt{\haslb{\Gamma}{\letstmt{x}{a}{t}}{\ms{L}}}
      = \upg{\dnt{\csplits{\Gamma}{\Delta}{\Xi}}}
      ; \dnt{\Delta} \otimes \dnt{\hasty{\Gamma}{1}{a}{A}}
      ; \dnt{\haslb{\Delta, \thyp{x}{A}{}}{t}{\ms{L}}}
      \\
    \dnt{\haslb{\Gamma}{\letstmt{(x, y)}{a}{t}}{\ms{L}}}
      = \upg{\dnt{\csplits{\Gamma}{\Delta}{\Xi}}}
        ; \dnt{\Delta} \otimes \dnt{\hasty{\Gamma}{1}{a}{A \otimes B}}
        ; \alpha
        ; \dnt{\haslb{\Delta, \thyp{x}{A}{}, \thyp{y}{B}{}}{t}{\ms{L}}}
      \\
    \dnt{\haslb{\Gamma}{\ewhere{t}{L}}{\ms{K}}}
      = \dnt{\haslb{\Gamma}{t}{\ms{L}}}
      ; \dnt{\lhaslb{\ms{L}}{L}{\ms{K}}}^\dagger
      \\
    \boxed{\dnt{\lhaslb{\ms{L}}{L}{\ms{K}}}
      : \mc{C}_1(\dnt{\ms{L}}, \dnt{\ms{K}} + \dnt{\ms{L}})}
      \\
    \dnt{\lhaslb{\ms{L}}{L, \lwbranch{\ell}{x: A}{t}}{\ms{K}}}
      = \dnt{\lhaslb{\ms{L}}{L}{\ms{K}, \llhyp{\ell}{A}{t}}}
      ; [[\iota_0, \dnt{\haslb{\Gamma, \thyp{x}{A}{}}{t}{L}}], \iota_1]
      \\
    \dnt{\lhaslb{\ms{L}}{\cdot}{\ms{L}}}
      = \iota_0
  \end{gather*}
  \caption{Semantics for \isotopessa blocks}
  \Description{Semantics for isotope-SSA blocks}
  \label{fig:ssa-structural-blocks}
\end{figure}

\begin{theorem}[Coherence]
  \begin{itemize}
    \item Given any two derivations \(D_1, D_2: \hasty{\Gamma}{p}{a}{A}\), \(\dnt{D_1} = \dnt{D_2}\)
    \item Given any two derivations \(D_1, D_2: \haslb{\Gamma}{t}{\ms{L}}\), \(\dnt{D_1} = \dnt{D_2}\)
  \end{itemize}
\end{theorem}

\begin{theorem}[Semantic Upgrade]
  For all \(\Gamma, a, A\), if \(\hasty{\Gamma}{0}{a}{A}\), then
  \[\dnt{\hasty{\Gamma}{1}{a}{A}} = \upg{\hasty{\Gamma}{0}{a}{A}}{}\]
\end{theorem}

\begin{figure}
  \begin{gather*}
    \boxed{\dnt{\issubst{\gamma}{\Theta}{\Gamma}}: \mc{C}_0(\dnt{\Theta}, \dnt{\Gamma})} \\
    \dnt{\issubst{\cdot}{\cdot}{\cdot}} = \ms{id} \qquad
    \dnt{\issubst{\substcons{\Gamma}{x}{a}}{\Theta}{\Gamma, \thyp{x}{A}{q}}}
      = \dnt{\csplits{\Theta}{\Theta_\Gamma}{\Theta_x}};\dnt{\issubst{\gamma}{\Theta_\Gamma}{\Gamma}} \otimes \dnt{\hasty{\Theta_x}{0}{a}{A}}
  \end{gather*}
  \caption{Semantics for \isotopessa substitutions}
  \Description{Semantics for isotope-SSA substitutions}
  \label{fig:ssa-subst-semantics}
\end{figure}

\begin{theorem}[Semantic Substitution] 
  Given \(\issubst{\gamma}{\Theta}{\Gamma}\),
  \begin{itemize}
    \item \(\upg{\dnt{\issubst{\gamma}{\Theta}{\Gamma}}}{p}
      ;\dnt{\hasty{\Gamma}{p}{a}{A}} 
      = \dnt{\hasty{\Theta}{p}{[\gamma]a}{A}}\)
    \item \(\upg{\dnt{\issubst{\gamma}{\Theta}{\Gamma}}}{}
      ; \dnt{\haslb{\Gamma}{t}{\ms{L}}}
      = \dnt{\haslb{\Theta}{[\gamma]t}{[\gamma]\ms{L}}}
      ; \sorry \)
  \end{itemize}
\end{theorem}

\TODO{\(\implies\) E-graph optimization}

\begin{figure}
  \begin{center}
    \TODO{this}
  \end{center}
  \caption{Grammar for \isotopessa blocks with holes}
  \Description{Grammar for isotope-SSA blocks with holes}
  \label{fig:blocks-with-holes}
\end{figure}

\begin{theorem}[Rewriting] \
  \TODO{this}
\end{theorem}

\section{Basic Models}

\TODO{Ye Olde Trace Monad}

\TODO{Is Elgot}

\TODO{Ye Olde Nondeterministic Trace Monad}

\TODO{Is Elgot}

\TODO{Ye Olde Reader/Writer/State Transformer}

\section{Weak Memory}

\TODO{Pomsets...}

\TODO{Form a monoid, so we can define...}

\TODO{The SC Monad, which, via composition w/ the state transformer, lets us}

\TODO{Build The Weak Memory Monad, which is too powerful, so we do...}

\TODO{Karoubi envelope as premonoidal demonstration?}

\section{Implementation}

\TODO{this}

\section{Related Work}

\TODO{\cite{promonad}}

\TODO{\cite{linear-state-usage}}

\TODO{\cite{ssa-is-fun}}

\TODO{\cite{sparky}}

\bibliographystyle{ACM-Reference-Format}
\bibliography{references}

\end{document}
\endinput
